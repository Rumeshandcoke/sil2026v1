<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sohum Hearing Screener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#202B5D',
              secondary: '#F3F4F6',
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
            }
          }
        }
      }
    </script>
    <style>
      body {
        margin: 0;
        background-color: #f9fafb;
        display: flex;
        justify-content: center;
        min-height: 100vh;
      }
      #root {
        width: 100%;
        max-width: 480px;
        background-color: white;
        min-height: 100vh;
        box-shadow: 0 0 20px rgba(0,0,0,0.05);
        position: relative;
        overflow-x: hidden;
      }
      ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react-dom/": "https://esm.sh/react-dom@^19.0.0/",
        "react/": "https://esm.sh/react@^19.0.0/",
        "react": "https://esm.sh/react@^19.0.0"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
import React, { useState } from 'react';
import { createRoot } from 'react-dom/client';

// ─── GOOGLE SHEETS URL (HARDCODED) ──────────────────────────────
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzLA7EkhUJW4gGpu4k68x66yy6sj1F1EWXRD02v-GjMY8gQUg46GgQsjNef863SwMTH/exec';

const generateBabyId = () => String(Date.now()).slice(-10);
const generateScreeningId = () => {
  const year = new Date().getFullYear().toString().slice(-2);
  const uniqueDigits = String(Date.now()).slice(-10);
  return `S-${year}-${uniqueDigits}`;
};

// ─── SHARED COMPONENTS ───────────────────────────────────────────

const Header = ({ title, subtitle, onBack }) => (
  React.createElement('div', { className: "bg-primary text-white pt-12 pb-6 px-6 rounded-b-[2rem] shadow-md relative" },
    onBack && React.createElement('button', { onClick: onBack, className: "absolute left-6 top-14 text-white/80 hover:text-white transition-colors" },
      React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
        React.createElement('path', { d: "m15 18-6-6 6-6" })
      )
    ),
    React.createElement('h1', { className: `text-2xl font-semibold tracking-wide ${onBack ? 'text-center' : ''}` }, title),
    subtitle && React.createElement('p', { className: `text-blue-200 text-sm mt-1 ${onBack ? 'text-center' : ''}` }, subtitle)
  )
);

const Container = ({ children, className = '' }) =>
  React.createElement('div', { className: `p-6 flex flex-col gap-5 ${className}` }, children);

const Card = ({ children, className = '', onClick }) =>
  React.createElement('div', {
    onClick,
    className: `bg-white rounded-2xl shadow-sm border border-gray-100 p-5 ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow active:scale-[0.99]' : ''} ${className}`
  }, children);

const Input = ({ label, error, className = '', ...props }) =>
  React.createElement('div', { className: "flex flex-col gap-1.5 w-full" },
    label && React.createElement('label', { className: "text-sm font-medium text-gray-700 ml-1" }, label),
    React.createElement('input', {
      className: `bg-secondary border-none rounded-xl px-4 py-3.5 text-gray-800 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all ${error ? 'ring-2 ring-red-400' : ''} ${className}`,
      ...props
    }),
    error && React.createElement('span', { className: "text-xs text-red-500 ml-1" }, error)
  );

const Select = ({ label, error, children, ...props }) =>
  React.createElement('div', { className: "flex flex-col gap-1.5 w-full" },
    label && React.createElement('label', { className: "text-sm font-medium text-gray-700 ml-1" }, label),
    React.createElement('select', {
      className: `bg-secondary border-none rounded-xl px-4 py-3.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary/20 appearance-none ${error ? 'ring-2 ring-red-400' : ''}`,
      ...props
    }, children),
    error && React.createElement('span', { className: "text-xs text-red-500 ml-1" }, error)
  );

const RadioGroup = ({ label, options, value, onChange }) =>
  React.createElement('div', { className: "flex flex-col gap-2" },
    React.createElement('label', { className: "text-sm font-medium text-gray-700 ml-1" }, label),
    React.createElement('div', { className: "flex gap-1.5" },
      options.map(opt =>
        React.createElement('button', {
          key: opt.value,
          type: "button",
          disabled: opt.disabled,
          onClick: () => !opt.disabled && onChange(opt.value),
          className: `flex-1 py-2.5 px-2 rounded-xl text-sm font-medium transition-colors border ${
            opt.disabled 
              ? 'bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed'
              : value === opt.value
              ? 'bg-primary border-primary text-white shadow-md'
              : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
          }`
        }, opt.label)
      )
    )
  );

const Button = ({ children, isLoading, className = '', disabled, ...props }) =>
  React.createElement('button', {
    disabled: disabled || isLoading,
    className: `w-full rounded-xl py-4 font-semibold text-center transition-all flex justify-center items-center gap-2 bg-primary text-white hover:bg-blue-900 active:bg-blue-950 shadow-md ${(disabled || isLoading) ? 'opacity-70 cursor-not-allowed' : ''} ${className}`,
    ...props
  },
    isLoading
      ? React.createElement('svg', { className: "animate-spin h-5 w-5 text-current", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
          React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
          React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
        )
      : children
  );

const StickyBottom = ({ children }) =>
  React.createElement('div', { className: "fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-6 mx-auto max-w-[480px]" }, children);

// ─── SCREEN 1: LOGIN ─────────────────────────────────────────────

const LoginScreen = ({ onSuccess }) => {
  const [userId, setUserId] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handle = () => {
    if (!userId || !password) { setError('Please enter both User ID and Password'); return; }
    const name = userId === 'admin' ? 'Arpita Jain' : userId;
    onSuccess(name, userId);
  };

  return React.createElement('div', { className: "flex flex-col min-h-screen bg-white" },
    React.createElement('div', { className: "flex-1 flex flex-col items-center justify-center p-8 text-center mt-[-10vh]" },
      React.createElement('div', { className: "w-24 h-24 bg-primary text-white rounded-3xl flex items-center justify-center text-4xl font-bold mb-8 shadow-lg shadow-blue-900/20" }, "S"),
      React.createElement('h1', { className: "text-3xl font-bold text-gray-900 mb-2" }, "Sohum"),
      React.createElement('p', { className: "text-gray-500 mb-10" }, "Hearing Screening System"),
      React.createElement('div', { className: "w-full flex flex-col gap-4" },
        React.createElement(Input, { placeholder: "User ID", value: userId, onChange: e => { setUserId(e.target.value); setError(''); } }),
        React.createElement(Input, { type: "password", placeholder: "Password", value: password, onChange: e => { setPassword(e.target.value); setError(''); } }),
        error && React.createElement('p', { className: "text-red-500 text-sm" }, error)
      )
    ),
    React.createElement('div', { className: "p-6" }, React.createElement(Button, { onClick: handle }, "Sign In"))
  );
};

// ─── SCREEN 2: SESSION SETUP ──────────────────────────────────────

const SessionSetupScreen = ({ initialData, onComplete }) => {
  const [hospital, setHospital] = useState(initialData.hospitalName || '');
  const [date, setDate] = useState(initialData.sessionDate || new Date().toISOString().split('T')[0]);
  const [error, setError] = useState('');

  const handle = () => {
    if (!hospital || !date) { setError('All fields are mandatory.'); return; }
    onComplete({ hospitalName: hospital, sessionDate: date });
  };

  return React.createElement('div', { className: "flex flex-col min-h-screen pb-24" },
    React.createElement(Header, { title: "Session Setup", subtitle: `Welcome, ${initialData.hwName}` }),
    React.createElement(Container, { className: "flex-1" },
      React.createElement('p', { className: "text-sm text-gray-500 px-1" }, "Select your hospital and confirm the date."),
      React.createElement(Select, { label: "Hospital *", value: hospital, onChange: e => { setHospital(e.target.value); setError(''); } },
        React.createElement('option', { value: "", disabled: true }, "Select hospital..."),
        React.createElement('option', { value: "Manipal BLR" }, "Manipal BLR"),
        React.createElement('option', { value: "Fortis BLR" }, "Fortis BLR"),
        React.createElement('option', { value: "Apollo BLR" }, "Apollo BLR"),
        React.createElement('option', { value: "Cloudnine BLR" }, "Cloudnine BLR")
      ),
      React.createElement(Input, { type: "date", label: "Date *", value: date, onChange: e => { setDate(e.target.value); setError(''); } }),
      error && React.createElement('p', { className: "text-red-500 text-sm" }, error)
    ),
    React.createElement(StickyBottom, null, React.createElement(Button, { onClick: handle }, "Start Session"))
  );
};

// ─── SCREEN 3: MAIN MENU ──────────────────────────────────────────

const MainMenuScreen = ({ record, onNewBaby }) =>
  React.createElement('div', { className: "flex flex-col min-h-screen bg-gray-50" },
    React.createElement('div', { className: "bg-primary pt-12 pb-24 px-6 rounded-b-[2.5rem] shadow-md" },
      React.createElement('div', { className: "flex justify-between items-center text-white mb-6" },
        React.createElement('div', null,
          React.createElement('h1', { className: "text-2xl font-bold" }, "Home"),
          React.createElement('p', { className: "text-blue-200 text-sm opacity-90" }, record.hospitalName),
          React.createElement('p', { className: "text-blue-100 text-xs opacity-75 mt-1" }, `Operator: ${record.hwName}`)
        ),
        React.createElement('div', { className: "w-10 h-10 bg-white/20 rounded-full flex items-center justify-center" },
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement('path', { d: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" }),
            React.createElement('circle', { cx: "12", cy: "7", r: "4" })
          )
        )
      ),
      React.createElement('div', { className: "inline-flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full text-xs text-white/90" },
        React.createElement('span', { className: "w-2 h-2 rounded-full bg-green-400" }),
        "Session Active"
      )
    ),
    React.createElement(Container, { className: "mt-[-4rem]" },
      React.createElement(Card, { onClick: onNewBaby, className: "flex flex-col items-center justify-center p-8 gap-4 shadow-lg border-none hover:-translate-y-1 transition-transform" },
        React.createElement('div', { className: "w-16 h-16 bg-blue-100 text-primary rounded-2xl flex items-center justify-center" },
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "32", height: "32", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement('path', { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }),
            React.createElement('circle', { cx: "9", cy: "7", r: "4" }),
            React.createElement('line', { x1: "19", x2: "19", y1: "8", y2: "14" }),
            React.createElement('line', { x1: "22", x2: "16", y1: "11", y2: "11" })
          )
        ),
        React.createElement('div', { className: "text-center" },
          React.createElement('h2', { className: "text-lg font-bold text-gray-800" }, "Register New Baby"),
          React.createElement('p', { className: "text-sm text-gray-500 mt-1" }, "Start a new screening process")
        )
      )
    )
  );

// ─── SCREEN 4: BABY REGISTRATION ─────────────────────────────────

const BabyRegistrationScreen = ({ onBack, onNext, initialData = {} }) => {
  const [form, setForm] = useState({ 
    babyId: initialData.babyId || generateBabyId(), 
    babyName: initialData.babyName || '', 
    dateOfBirth: initialData.dateOfBirth || '', 
    gender: initialData.gender || '', 
    gestationalAge: initialData.gestationalAge || '', 
    parentName: initialData.parentName || '', 
    parentPhone: initialData.parentPhone || '', 
    parentEmail: initialData.parentEmail || '' 
  });
  const [riskFactors, setRiskFactors] = useState(initialData.riskFactors || []);
  const [error, setError] = useState('');

  const riskOptions = [
    "NICU > 5 days",
    "Family history of hearing loss",
    "Craniofacial anomalies",
    "In utero infections",
    "Hyperbilirubinemia",
    "Syndromes associated with hearing loss"
  ];

  const toggleRisk = r => setRiskFactors(prev => prev.includes(r) ? prev.filter(x => x !== r) : [...prev, r]);

  const handle = () => {
    if (!form.babyName || !form.dateOfBirth || !form.gender || !form.gestationalAge || !form.parentName || !form.parentPhone) {
      setError('Please fill out all required fields.'); return;
    }
    if (form.parentName.length < 3) {
      setError('Parent name must be at least 3 characters.'); return;
    }
    if (!/^\d{10}$/.test(form.parentPhone)) {
      setError('Please enter a valid 10-digit phone number.'); return;
    }
    if (form.parentEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.parentEmail)) {
      setError('Please enter a valid email address.'); return;
    }
    onNext({ ...form, riskFactors, screeningId: generateScreeningId() });
  };

  return React.createElement('div', { className: "flex flex-col min-h-screen pb-24" },
    React.createElement(Header, { title: "Patient Information", onBack }),
    React.createElement(Container, null,
      React.createElement(Input, { label: "Baby ID", value: form.babyId, disabled: true, className: "opacity-60" }),
      React.createElement(Input, { label: "Baby's Name *", value: form.babyName, onChange: e => setForm({...form, babyName: e.target.value}) }),
      React.createElement('div', { className: "flex gap-3 items-end" },
        React.createElement('div', { className: "flex-1" },
          React.createElement(Input, { type: "date", label: "Date of Birth *", max: new Date().toISOString().split('T')[0], value: form.dateOfBirth, onChange: e => setForm({...form, dateOfBirth: e.target.value}) })
        ),
        React.createElement('div', { className: "flex-1" },
          React.createElement(RadioGroup, { label: "Gender *", value: form.gender, onChange: v => setForm({...form, gender: v}), options: [{label:'M',value:'Male'},{label:'F',value:'Female'},{label:'O',value:'Other'}] })
        )
      ),

      React.createElement(Select, { label: "Gestational Age (weeks) *", value: form.gestationalAge, onChange: e => setForm({...form, gestationalAge: e.target.value}) },
        React.createElement('option', { value: "", disabled: true }, "Select weeks..."),
        ...(() => { const opts = []; for (let i = 25; i <= 50; i++) { opts.push(React.createElement('option', { key: i, value: i }, i)); } return opts; })()
      ),

      React.createElement('div', { className: "flex flex-col gap-2" },
        React.createElement('label', { className: "text-sm font-medium text-gray-700 ml-1" }, "Risk Factors"),
        React.createElement('div', { className: "bg-secondary rounded-xl p-4 flex flex-col gap-3" },
          riskOptions.map(r =>
            React.createElement('label', { key: r, className: "flex items-start gap-3 cursor-pointer" },
              React.createElement('input', { type: "checkbox", className: "mt-1 w-4 h-4 text-primary bg-white border-gray-300 rounded focus:ring-primary", checked: riskFactors.includes(r), onChange: () => toggleRisk(r) }),
              React.createElement('span', { className: "text-sm text-gray-700 leading-snug" }, r)
            )
          ),
          riskFactors.length === 0 && React.createElement('p', { className: "text-xs text-gray-400 italic ml-7" }, "No risk factors selected")
        )
      ),

      React.createElement('div', { className: "h-px bg-gray-200" }),
      React.createElement(Input, { label: "Parent / Guardian Name *", value: form.parentName, onChange: e => setForm({...form, parentName: e.target.value}) }),
      React.createElement(Input, { 
        label: "Phone Number *", 
        type: "tel", 
        placeholder: "10-digit number", 
        value: form.parentPhone, 
        onChange: e => {
          const val = e.target.value.replace(/\D/g, '');
          setForm({...form, parentPhone: val});
        },
        maxLength: 10
      }),
      React.createElement(Input, { label: "Parent Email (Optional)", type: "email", placeholder: "email@example.com", value: form.parentEmail, onChange: e => setForm({...form, parentEmail: e.target.value}) }),
      error && React.createElement('p', { className: "text-red-500 text-sm" }, error),
      React.createElement('button', {
        type: "button",
        onClick: () => {
          if (confirm('Clear all fields? Baby ID will remain.')) {
            onClear();
            setForm({ babyId: form.babyId, babyName: '', dateOfBirth: '', gender: '', gestationalAge: '', parentName: '', parentPhone: '', parentEmail: '' });
            setRiskFactors([]);
          }
        },
        className: "text-sm text-gray-500 hover:text-gray-700 underline mt-2"
      }, "Clear All Fields")
    ),
    React.createElement(StickyBottom, null, React.createElement(Button, { onClick: handle }, "Continue to Test Selection"))
  );
};

// ─── SCREEN 5: TEST SELECTION ─────────────────────────────────────

const TestSelectionScreen = ({ onBack, onSelect }) =>
  React.createElement('div', { className: "flex flex-col min-h-screen bg-gray-50" },
    React.createElement(Header, { title: "Select Test Type", onBack }),
    React.createElement(Container, { className: "flex-1 justify-center gap-6 pb-20" },
      React.createElement(Card, { onClick: () => onSelect('AABR'), className: "flex flex-col items-center justify-center p-10 py-16 gap-4 border-2 border-transparent hover:border-primary/20" },
        React.createElement('h2', { className: "text-2xl font-bold text-primary tracking-wider" }, "AABR"),
        React.createElement('p', { className: "text-sm text-gray-500 text-center" }, "Automated Auditory Brainstem Response")
      ),
      React.createElement(Card, { onClick: () => onSelect('OAE'), className: "flex flex-col items-center justify-center p-10 py-16 gap-4 border-2 border-transparent hover:border-primary/20" },
        React.createElement('h2', { className: "text-2xl font-bold text-primary tracking-wider" }, "OAE"),
        React.createElement('p', { className: "text-sm text-gray-500 text-center" }, "Otoacoustic Emissions")
      )
    )
  );

// ─── SCREEN 6: AABR ENTRY ─────────────────────────────────────────

const AABREntryScreen = ({ onBack, onNext, initialData = {} }) => {
  const [activeTab, setActiveTab] = useState('left');
  const [impedance, setImpedance] = useState({ 
    vtxGnd: initialData.impedanceVtxGnd || '', 
    gndRef: initialData.impedanceGndRef || '', 
    refVtx: initialData.impedanceRefVtx || '' 
  });
  const [leftData, setLeftData] = useState({ 
    result35dB: initialData.leftResult35dB || '', 
    result50dB: initialData.leftResult50dB || '', 
    result70dB: initialData.leftResult70dB || '', 
    result90dB: initialData.leftResult90dB || '' 
  });
  const [rightData, setRightData] = useState({ 
    result35dB: initialData.rightResult35dB || '', 
    result50dB: initialData.rightResult50dB || '', 
    result70dB: initialData.rightResult70dB || '', 
    result90dB: initialData.rightResult90dB || '' 
  });
  const [error, setError] = useState('');

  const resultOpts = [{label:'PASS',value:'PASS'},{label:'REFER',value:'REFER'},{label:'REDO',value:'REDO'}];

  const handle = () => {
    if (!impedance.vtxGnd || !impedance.gndRef || !impedance.refVtx) {
      setError('All impedance values are required.'); return;
    }
    
    const leftHasTest = leftData.result35dB || leftData.result50dB || leftData.result70dB || leftData.result90dB;
    const rightHasTest = rightData.result35dB || rightData.result50dB || rightData.result70dB || rightData.result90dB;
    
    if (!leftHasTest && !rightHasTest) {
      setError('At least one test result is required (any dB level, any ear).'); return;
    }
    
    onNext({
      impedanceVtxGnd: impedance.vtxGnd,
      impedanceGndRef: impedance.gndRef,
      impedanceRefVtx: impedance.refVtx,
      leftResult35dB: leftData.result35dB || '',
      leftResult50dB: leftData.result50dB || '',
      leftResult70dB: leftData.result70dB || '',
      leftResult90dB: leftData.result90dB || '',
      rightResult35dB: rightData.result35dB || '',
      rightResult50dB: rightData.result50dB || '',
      rightResult70dB: rightData.result70dB || '',
      rightResult90dB: rightData.result90dB || ''
    });
  };

  const currentData = activeTab === 'left' ? leftData : rightData;
  const setCurrentData = activeTab === 'left' ? setLeftData : setRightData;

  return React.createElement('div', { className: "flex flex-col min-h-screen pb-24" },
    React.createElement(Header, { title: "AABR Entry", subtitle: "Automated Auditory Brainstem Response", onBack }),
    React.createElement(Container, { className: "gap-5" },
      React.createElement('div', { className: "flex flex-col gap-2" },
        React.createElement('label', { className: "text-sm font-medium text-gray-700 ml-1" }, "Impedance (kΩ) *"),
        React.createElement('div', { className: "grid grid-cols-3 gap-3" },
          React.createElement('div', null,
            React.createElement('label', { className: "text-xs text-gray-500 ml-1 mb-1 block" }, "VTX - GND"),
            React.createElement('input', {
              type: "tel",
              placeholder: "kΩ",
              value: impedance.vtxGnd,
              onChange: e => setImpedance({...impedance, vtxGnd: e.target.value}),
              className: "w-full bg-secondary border-none rounded-xl px-3 py-3 text-gray-800 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/20"
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: "text-xs text-gray-500 ml-1 mb-1 block" }, "GND - REF"),
            React.createElement('input', {
              type: "tel",
              placeholder: "kΩ",
              value: impedance.gndRef,
              onChange: e => setImpedance({...impedance, gndRef: e.target.value}),
              className: "w-full bg-secondary border-none rounded-xl px-3 py-3 text-gray-800 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/20"
            })
          ),
          React.createElement('div', null,
            React.createElement('label', { className: "text-xs text-gray-500 ml-1 mb-1 block" }, "REF - VTX"),
            React.createElement('input', {
              type: "tel",
              placeholder: "kΩ",
              value: impedance.refVtx,
              onChange: e => setImpedance({...impedance, refVtx: e.target.value}),
              className: "w-full bg-secondary border-none rounded-xl px-3 py-3 text-gray-800 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/20"
            })
          )
        )
      ),

      React.createElement('div', { className: "flex gap-2 border-b border-gray-200" },
        React.createElement('button', {
          onClick: () => setActiveTab('left'),
          className: `flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'left' ? 'border-primary text-primary' : 'border-transparent text-gray-500'}`
        }, "Left Ear"),
        React.createElement('button', {
          onClick: () => setActiveTab('right'),
          className: `flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'right' ? 'border-primary text-primary' : 'border-transparent text-gray-500'}`
        }, "Right Ear")
      ),

      React.createElement('div', { className: "bg-gray-50 rounded-2xl p-4 border border-gray-100 flex flex-col gap-4" },
        React.createElement('h3', { className: "text-sm font-semibold text-gray-700 uppercase tracking-wider" }, 
          activeTab === 'left' ? 'Left Ear Results' : 'Right Ear Results'
        ),
        React.createElement('div', { className: "flex flex-col gap-3" },
          React.createElement(RadioGroup, { 
            label: "90 dB", 
            value: currentData.result90dB, 
            onChange: v => setCurrentData({...currentData, result90dB: v}), 
            options: resultOpts 
          }),
          React.createElement(RadioGroup, { 
            label: "70 dB", 
            value: currentData.result70dB, 
            onChange: v => setCurrentData({...currentData, result70dB: v}), 
            options: resultOpts
          }),
          React.createElement(RadioGroup, { 
            label: "50 dB", 
            value: currentData.result50dB, 
            onChange: v => setCurrentData({...currentData, result50dB: v}), 
            options: resultOpts
          }),
          React.createElement(RadioGroup, { 
            label: "35 dB", 
            value: currentData.result35dB, 
            onChange: v => setCurrentData({...currentData, result35dB: v}), 
            options: resultOpts
          })
        )
      ),

      error && React.createElement('p', { className: "text-red-500 text-sm" }, error)
    ),
    React.createElement(StickyBottom, null, React.createElement(Button, { onClick: handle }, "Proceed to Recommendation"))
  );
};

// ─── SCREEN 7A: OAE TYPE SELECTION ────────────────────────────

const OAETypeScreen = ({ onBack, onNext }) => {
  const [oaeType, setOaeType] = useState('');
  const [error, setError] = useState('');

  const handle = () => {
    if (!oaeType) { setError('Please select OAE test type.'); return; }
    onNext({ oaeTestType: oaeType });
  };

  return React.createElement('div', { className: "flex flex-col min-h-screen bg-gray-50 pb-16" },
    React.createElement(Header, { title: "OAE Test Type", subtitle: "Select OAE Type", onBack }),
    React.createElement(Container, { className: "flex-1 justify-center gap-6 pb-20" },
      React.createElement(Card, { onClick: () => setOaeType('DPOAE'), className: "flex flex-col items-center justify-center p-10 py-16 gap-4 border-2 " + (oaeType === 'DPOAE' ? 'border-primary bg-blue-50' : 'border-transparent') },
        React.createElement('h2', { className: "text-2xl font-bold text-primary tracking-wider" }, "DPOAE"),
        React.createElement('p', { className: "text-sm text-gray-500 text-center" }, "Distortion Product OAE")
      ),
      React.createElement(Card, { onClick: () => setOaeType('TEOAE'), className: "flex flex-col items-center justify-center p-10 py-16 gap-4 border-2 " + (oaeType === 'TEOAE' ? 'border-primary bg-blue-50' : 'border-transparent') },
        React.createElement('h2', { className: "text-2xl font-bold text-primary tracking-wider" }, "TEOAE"),
        React.createElement('p', { className: "text-sm text-gray-500 text-center" }, "Transient Evoked OAE")
      ),
      error && React.createElement('p', { className: "text-red-500 text-sm text-center" }, error)
    ),
    oaeType && React.createElement(StickyBottom, null, React.createElement(Button, { onClick: handle }, "Continue to Protocol Selection"))
  );
};

// ─── SCREEN 7B: OAE PROTOCOL SELECTION ────────────────────────────

const OAEProtocolScreen = ({ oaeType, onBack, onNext }) => {
  const [protocol, setProtocol] = useState('');
  const [error, setError] = useState('');

  const handle = () => {
    if (!protocol) { setError('Please select a protocol.'); return; }
    onNext({ oaeProtocol: protocol });
  };

  const dpoaeProtocols = {
    '1-6 kHz': 'Testing frequencies: 1.5k, 2k, 3k, 4k, 6k Hz',
    '2-4 kHz': 'Testing frequencies: 2k, 3k, 4k Hz',
    '2-6 kHz': 'Testing frequencies: 2k, 3k, 4k, 5k, 6k Hz'
  };

  const teoaeProtocols = {
    '8 seconds': 'Testing frequencies: 1.5k, 2k, 3k, 4k, 6k Hz',
    '32 seconds': 'Testing frequencies: 1.5k, 2k, 3k, 4k, 6k Hz'
  };

  const protocols = oaeType === 'DPOAE' ? dpoaeProtocols : teoaeProtocols;

  return React.createElement('div', { className: "flex flex-col min-h-screen pb-24" },
    React.createElement(Header, { title: oaeType + " Protocol", subtitle: "Select Testing Protocol", onBack }),
    React.createElement(Container, { className: "flex-1" },
      React.createElement(Select, { label: "Protocol *", value: protocol, onChange: e => { setProtocol(e.target.value); setError(''); } },
        React.createElement('option', { value: "", disabled: true }, "Select protocol..."),
        oaeType === 'DPOAE' 
          ? [
              React.createElement('option', { key: '1', value: "1-6 kHz" }, "Protocol 1: 1-6 kHz"),
              React.createElement('option', { key: '2', value: "2-4 kHz" }, "Protocol 2: 2-4 kHz"),
              React.createElement('option', { key: '3', value: "2-6 kHz" }, "Protocol 3: 2-6 kHz")
            ]
          : [
              React.createElement('option', { key: '1', value: "8 seconds" }, "8 seconds"),
              React.createElement('option', { key: '2', value: "32 seconds" }, "32 seconds")
            ]
      ),
      protocol && React.createElement(Card, { className: "bg-blue-50 border-blue-100" },
        React.createElement('div', { className: "flex gap-3 items-start" },
          React.createElement('svg', { className: "text-blue-500 shrink-0 mt-0.5", xmlns: "http://www.w3.org/2000/svg", width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement('circle', { cx: "12", cy: "12", r: "10" }),
            React.createElement('path', { d: "M12 16v-4" }),
            React.createElement('path', { d: "M12 8h.01" })
          ),
          React.createElement('div', null,
            React.createElement('p', { className: "text-sm font-semibold text-blue-900" }, protocol),
            React.createElement('p', { className: "text-xs text-blue-700 mt-1" }, protocols[protocol])
          )
        )
      ),
      error && React.createElement('p', { className: "text-red-500 text-sm" }, error)
    ),
    React.createElement(StickyBottom, null, React.createElement(Button, { onClick: handle }, "Continue to OAE Entry"))
  );
};

// ─── SCREEN 7C: OAE ENTRY (DPOAE - Dynamic) ──────────────────────────────────────────

const DPOAEEntryScreen = ({ protocol, onBack, onNext }) => {
  const [activeTab, setActiveTab] = useState('left');
  
  // Static state - ALL possible SNR fields created upfront
  const [data, setData] = useState({
    oaeLeftResult: '',
    oaeRightResult: '',
    snr1_5kLeft: '',
    snr1_5kRight: '',
    snr2kLeft: '',
    snr2kRight: '',
    snr3kLeft: '',
    snr3kRight: '',
    snr4kLeft: '',
    snr4kRight: '',
    snr5kLeft: '',
    snr5kRight: '',
    snr6kLeft: '',
    snr6kRight: ''
  });
  const [error, setError] = useState('');

  const resultOpts = [{label:'PASS',value:'PASS'},{label:'REFER',value:'REFER'}];

  const frequencyConfigs = {
    '1-6 kHz': [
      { key: '1_5k', label: '1.5k Hz' },
      { key: '2k', label: '2k Hz' },
      { key: '3k', label: '3k Hz' },
      { key: '4k', label: '4k Hz' },
      { key: '6k', label: '6k Hz' }
    ],
    '2-4 kHz': [
      { key: '2k', label: '2k Hz' },
      { key: '3k', label: '3k Hz' },
      { key: '4k', label: '4k Hz' }
    ],
    '2-6 kHz': [
      { key: '2k', label: '2k Hz' },
      { key: '3k', label: '3k Hz' },
      { key: '4k', label: '4k Hz' },
      { key: '5k', label: '5k Hz' },
      { key: '6k', label: '6k Hz' }
    ]
  };

  const frequencies = frequencyConfigs[protocol];

  const handle = () => {
    if (!data.oaeLeftResult || !data.oaeRightResult) { 
      setError('Please select PASS or REFER for both ears.'); return; 
    }
    for (const freq of frequencies) {
      if (!data['snr' + freq.key + 'Left'] || !data['snr' + freq.key + 'Right']) {
        setError('All SNR fields are required.'); return;
      }
    }
    
    // Validate SNR-based PASS/REFER logic
    const threshold = 6.0;
    const requiredPasses = frequencies.length === 3 ? 2 : 3;
    
    const validateEar = (ear) => {
      let passCount = 0;
      for (const freq of frequencies) {
        const snrValue = parseFloat(data['snr' + freq.key + ear]);
        if (snrValue >= threshold) passCount++;
      }
      return passCount >= requiredPasses ? 'PASS' : 'REFER';
    };
    
    const expectedLeft = validateEar('Left');
    const expectedRight = validateEar('Right');
    
    if (data.oaeLeftResult !== expectedLeft || data.oaeRightResult !== expectedRight) {
      const warning = 'WARNING: Based on SNR values (threshold: 6.0 dB):\n\n' +
        'Left ear should be: ' + expectedLeft + ' (you selected: ' + data.oaeLeftResult + ')\n' +
        'Right ear should be: ' + expectedRight + ' (you selected: ' + data.oaeRightResult + ')\n\n' +
        'Click OK to proceed anyway, or Cancel to review.';
      if (!confirm(warning)) { setError('Please review your selections.'); return; }
    }
    
    onNext(data);
  };

  const SNRInput = ({ freqKey, label, ear }) => {
    const fieldKey = 'snr' + freqKey + ear;
    const snrOptions = [];
    
    // 0.0 to 30.0 in 0.1 steps
    for (let i = 0; i <= 30; i += 0.1) {
      snrOptions.push(i.toFixed(1));
    }
    // Add >30.0 option
    snrOptions.push('>30.0');
    
    let value;
    if (fieldKey === 'snr1_5kLeft') value = data.snr1_5kLeft;
    else if (fieldKey === 'snr1_5kRight') value = data.snr1_5kRight;
    else if (fieldKey === 'snr2kLeft') value = data.snr2kLeft;
    else if (fieldKey === 'snr2kRight') value = data.snr2kRight;
    else if (fieldKey === 'snr3kLeft') value = data.snr3kLeft;
    else if (fieldKey === 'snr3kRight') value = data.snr3kRight;
    else if (fieldKey === 'snr4kLeft') value = data.snr4kLeft;
    else if (fieldKey === 'snr4kRight') value = data.snr4kRight;
    else if (fieldKey === 'snr5kLeft') value = data.snr5kLeft;
    else if (fieldKey === 'snr5kRight') value = data.snr5kRight;
    else if (fieldKey === 'snr6kLeft') value = data.snr6kLeft;
    else if (fieldKey === 'snr6kRight') value = data.snr6kRight;
    
    let setValue;
    if (fieldKey === 'snr1_5kLeft') setValue = (val) => setData({...data, snr1_5kLeft: val});
    else if (fieldKey === 'snr1_5kRight') setValue = (val) => setData({...data, snr1_5kRight: val});
    else if (fieldKey === 'snr2kLeft') setValue = (val) => setData({...data, snr2kLeft: val});
    else if (fieldKey === 'snr2kRight') setValue = (val) => setData({...data, snr2kRight: val});
    else if (fieldKey === 'snr3kLeft') setValue = (val) => setData({...data, snr3kLeft: val});
    else if (fieldKey === 'snr3kRight') setValue = (val) => setData({...data, snr3kRight: val});
    else if (fieldKey === 'snr4kLeft') setValue = (val) => setData({...data, snr4kLeft: val});
    else if (fieldKey === 'snr4kRight') setValue = (val) => setData({...data, snr4kRight: val});
    else if (fieldKey === 'snr5kLeft') setValue = (val) => setData({...data, snr5kLeft: val});
    else if (fieldKey === 'snr5kRight') setValue = (val) => setData({...data, snr5kRight: val});
    else if (fieldKey === 'snr6kLeft') setValue = (val) => setData({...data, snr6kLeft: val});
    else if (fieldKey === 'snr6kRight') setValue = (val) => setData({...data, snr6kRight: val});
    
    return React.createElement('div', { className: "flex items-center justify-between py-2" },
      React.createElement('label', { className: "text-sm text-gray-700" }, label),
      React.createElement('select', {
        value: value || '',
        onChange: e => setValue(e.target.value),
        className: "w-20 bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm text-center focus:outline-none focus:ring-2 focus:ring-primary/30"
      },
        React.createElement('option', { value: '' }, '-- dB'),
        snrOptions.map(val => React.createElement('option', { key: val, value: val }, val))
      )
    );
  };

  return React.createElement('div', { className: "flex flex-col min-h-screen pb-24" },
    React.createElement(Header, { title: "DPOAE Entry", subtitle: protocol, onBack }),
    React.createElement(Container, { className: "gap-5" },
      React.createElement('div', { className: "flex gap-2 border-b border-gray-200" },
        React.createElement('button', {
          onClick: () => setActiveTab('left'),
          className: `flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'left' ? 'border-primary text-primary' : 'border-transparent text-gray-500'}`
        }, "Left Ear"),
        React.createElement('button', {
          onClick: () => setActiveTab('right'),
          className: `flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'right' ? 'border-primary text-primary' : 'border-transparent text-gray-500'}`
        }, "Right Ear")
      ),

      React.createElement('div', { className: "bg-gray-50 rounded-2xl p-4 border border-gray-100" },
        React.createElement('h3', { className: "text-xs font-semibold text-gray-700 uppercase tracking-wider mb-3" }, 
          activeTab === 'left' ? 'Left Ear' : 'Right Ear'
        ),
        React.createElement(RadioGroup, { 
          label: "Result *", 
          value: activeTab === 'left' ? data.oaeLeftResult : data.oaeRightResult, 
          onChange: v => setData({...data, [activeTab === 'left' ? 'oaeLeftResult' : 'oaeRightResult']: v}), 
          options: resultOpts 
        }),
        React.createElement('div', { className: "mt-4" },
          frequencies.map(f => React.createElement(SNRInput, { 
            key: f.key + (activeTab === 'left' ? 'L' : 'R'), 
            freqKey: f.key, 
            label: f.label, 
            ear: activeTab === 'left' ? 'Left' : 'Right' 
          }))
        )
      ),
      
      error && React.createElement('p', { className: "text-red-500 text-sm" }, error)
    ),
    React.createElement(StickyBottom, null, React.createElement(Button, { onClick: handle }, "Proceed to Recommendation"))
  );
};

// ─── SCREEN 7D: OAE ENTRY (TEOAE - Fixed 5 frequencies) ──────────────────────────────────────────

const TEOAEEntryScreen = ({ protocol, onBack, onNext }) => {
  const [activeTab, setActiveTab] = useState('left');
  const [data, setData] = useState({ 
    oaeLeftResult: '', 
    oaeRightResult: '',
    snr1_5kLeft: '', snr1_5kRight: '',
    snr2kLeft: '', snr2kRight: '',
    snr3kLeft: '', snr3kRight: '',
    snr4kLeft: '', snr4kRight: '',
    snr6kLeft: '', snr6kRight: ''
  });
  const [error, setError] = useState('');

  const resultOpts = [{label:'PASS',value:'PASS'},{label:'REFER',value:'REFER'}];

  const frequencies = [
    { key: '1_5k', label: '1.5k Hz' },
    { key: '2k', label: '2k Hz' },
    { key: '3k', label: '3k Hz' },
    { key: '4k', label: '4k Hz' },
    { key: '6k', label: '6k Hz' }
  ];

  const handle = () => {
    // Check if left ear has any data
    const leftHasData = data.oaeLeftResult || frequencies.some(f => data['snr' + f.key + 'Left']);
    const rightHasData = data.oaeRightResult || frequencies.some(f => data['snr' + f.key + 'Right']);
    
    // If left ear has any data, all left fields must be filled
    if (leftHasData) {
      if (!data.oaeLeftResult) {
        setError('Left ear: Result is required if any SNR is entered.'); return;
      }
      for (const freq of frequencies) {
        if (!data['snr' + freq.key + 'Left']) {
          setError('Left ear: All SNR fields are required if testing this ear.'); return;
        }
      }
    }
    
    // If right ear has any data, all right fields must be filled
    if (rightHasData) {
      if (!data.oaeRightResult) {
        setError('Right ear: Result is required if any SNR is entered.'); return;
      }
      for (const freq of frequencies) {
        if (!data['snr' + freq.key + 'Right']) {
          setError('Right ear: All SNR fields are required if testing this ear.'); return;
        }
      }
    }
    
    // At least one ear must be tested
    if (!leftHasData && !rightHasData) {
      setError('At least one ear must be tested.'); return;
    }
    
    onNext(data);
  };

  const SNRInput = ({ freqKey, label, ear }) => {
    const fieldKey = 'snr' + freqKey + ear;
    const snrOptions = [];
    
    // 0.0 to 30.0 in 0.1 steps
    for (let i = 0; i <= 30; i += 0.1) {
      snrOptions.push(i.toFixed(1));
    }
    // Add >30.0 option
    snrOptions.push('>30.0');
    
    let value;
    if (fieldKey === 'snr1_5kLeft') value = data.snr1_5kLeft;
    else if (fieldKey === 'snr1_5kRight') value = data.snr1_5kRight;
    else if (fieldKey === 'snr2kLeft') value = data.snr2kLeft;
    else if (fieldKey === 'snr2kRight') value = data.snr2kRight;
    else if (fieldKey === 'snr3kLeft') value = data.snr3kLeft;
    else if (fieldKey === 'snr3kRight') value = data.snr3kRight;
    else if (fieldKey === 'snr4kLeft') value = data.snr4kLeft;
    else if (fieldKey === 'snr4kRight') value = data.snr4kRight;
    else if (fieldKey === 'snr6kLeft') value = data.snr6kLeft;
    else if (fieldKey === 'snr6kRight') value = data.snr6kRight;
    
    let setValue;
    if (fieldKey === 'snr1_5kLeft') setValue = (val) => setData({...data, snr1_5kLeft: val});
    else if (fieldKey === 'snr1_5kRight') setValue = (val) => setData({...data, snr1_5kRight: val});
    else if (fieldKey === 'snr2kLeft') setValue = (val) => setData({...data, snr2kLeft: val});
    else if (fieldKey === 'snr2kRight') setValue = (val) => setData({...data, snr2kRight: val});
    else if (fieldKey === 'snr3kLeft') setValue = (val) => setData({...data, snr3kLeft: val});
    else if (fieldKey === 'snr3kRight') setValue = (val) => setData({...data, snr3kRight: val});
    else if (fieldKey === 'snr4kLeft') setValue = (val) => setData({...data, snr4kLeft: val});
    else if (fieldKey === 'snr4kRight') setValue = (val) => setData({...data, snr4kRight: val});
    else if (fieldKey === 'snr6kLeft') setValue = (val) => setData({...data, snr6kLeft: val});
    else if (fieldKey === 'snr6kRight') setValue = (val) => setData({...data, snr6kRight: val});
    
    return React.createElement('div', { className: "flex items-center justify-between py-2" },
      React.createElement('label', { className: "text-sm text-gray-700" }, label),
      React.createElement('select', {
        value: value || '',
        onChange: e => setValue(e.target.value),
        className: "w-20 bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm text-center focus:outline-none focus:ring-2 focus:ring-primary/30"
      },
        React.createElement('option', { value: '' }, '-- dB'),
        snrOptions.map(val => React.createElement('option', { key: val, value: val }, val))
      )
    );
  };

  return React.createElement('div', { className: "flex flex-col min-h-screen pb-24" },
    React.createElement(Header, { title: "TEOAE Entry", subtitle: protocol, onBack }),
    React.createElement(Container, { className: "gap-5" },
      React.createElement('div', { className: "flex gap-2 border-b border-gray-200" },
        React.createElement('button', {
          onClick: () => setActiveTab('left'),
          className: `flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'left' ? 'border-primary text-primary' : 'border-transparent text-gray-500'}`
        }, "Left Ear"),
        React.createElement('button', {
          onClick: () => setActiveTab('right'),
          className: `flex-1 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'right' ? 'border-primary text-primary' : 'border-transparent text-gray-500'}`
        }, "Right Ear")
      ),

      React.createElement('div', { className: "bg-gray-50 rounded-2xl p-4 border border-gray-100" },
        React.createElement('h3', { className: "text-xs font-semibold text-gray-700 uppercase tracking-wider mb-3" }, 
          activeTab === 'left' ? 'Left Ear' : 'Right Ear'
        ),
        React.createElement(RadioGroup, { 
          label: "Result", 
          value: activeTab === 'left' ? data.oaeLeftResult : data.oaeRightResult, 
          onChange: v => setData({...data, [activeTab === 'left' ? 'oaeLeftResult' : 'oaeRightResult']: v}), 
          options: resultOpts 
        }),
        React.createElement('div', { className: "mt-4" },
          frequencies.map(f => React.createElement(SNRInput, { 
            key: f.key + (activeTab === 'left' ? 'L' : 'R'), 
            freqKey: f.key, 
            label: f.label, 
            ear: activeTab === 'left' ? 'Left' : 'Right' 
          }))
        )
      ),
      
      error && React.createElement('p', { className: "text-red-500 text-sm" }, error)
    ),
    React.createElement(StickyBottom, null, React.createElement(Button, { onClick: handle }, "Proceed to Recommendation"))
  );
};

// ─── SCREEN 8: RECOMMENDATION ────────────────────────────────────

const RecommendationScreen = ({ onBack, onSave }) => {
  const [rec, setRec] = useState('');
  const [error, setError] = useState('');

  const handle = () => {
    if (!rec) { setError('Please select a recommendation.'); return; }
    onSave(rec);
  };

  return React.createElement('div', { className: "flex flex-col min-h-screen pb-24" },
    React.createElement(Header, { title: "Recommendation", onBack }),
    React.createElement(Container, { className: "flex-1 mt-2" },
      React.createElement(Select, { label: "Final Action / Recommendation *", value: rec, onChange: e => { setRec(e.target.value); setError(''); } },
        React.createElement('option', { value: "", disabled: true }, "Select an action..."),
        React.createElement('option', { value: "No Action Required" }, "No Action Required"),
        React.createElement('option', { value: "Repeat Screening" }, "Repeat Screening"),
        React.createElement('option', { value: "Refer for Diagnostic BERA" }, "Refer for Diagnostic BERA"),
        React.createElement('option', { value: "Follow Up Required" }, "Follow Up Required")
      ),
      React.createElement(Card, { className: "bg-blue-50 border-blue-100" },
        React.createElement('div', { className: "flex gap-3 items-start" },
          React.createElement('svg', { className: "text-blue-500 shrink-0 mt-0.5", xmlns: "http://www.w3.org/2000/svg", width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement('circle', { cx: "12", cy: "12", r: "10" }),
            React.createElement('path', { d: "M12 16v-4" }),
            React.createElement('path', { d: "M12 8h.01" })
          ),
          React.createElement('p', { className: "text-sm text-blue-900 leading-relaxed" }, "Clicking save will compile the complete Screening Record and push the data to the database. Ensure all information is accurate.")
        )
      ),
      error && React.createElement('p', { className: "text-red-500 text-sm" }, error)
    ),
    React.createElement(StickyBottom, null, React.createElement(Button, { onClick: handle }, "Save Record"))
  );
};

// ─── SCREEN 9: SYNCING ───────────────────────────────────────────

const SyncingScreen = () =>
  React.createElement('div', { className: "flex flex-col min-h-screen bg-white items-center justify-center p-8 text-center gap-6" },
    React.createElement('svg', { className: "animate-spin h-12 w-12 text-primary", xmlns: "http://www.w3.org/2000/svg", fill: "none", viewBox: "0 0 24 24" },
      React.createElement('circle', { className: "opacity-25", cx: "12", cy: "12", r: "10", stroke: "currentColor", strokeWidth: "4" }),
      React.createElement('path', { className: "opacity-75", fill: "currentColor", d: "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" })
    ),
    React.createElement('div', null,
      React.createElement('h2', { className: "text-xl font-semibold text-gray-800" }, "Saving Record..."),
      React.createElement('p', { className: "text-gray-500 mt-2 text-sm" }, "Pushing data securely to the database.")
    )
  );

// ─── SCREEN 10: SUCCESS ──────────────────────────────────────────

const SuccessScreen = ({ record, onReturn }) =>
  React.createElement('div', { className: "flex flex-col min-h-screen bg-gray-50" },
    React.createElement(Header, { title: "Success" }),
    React.createElement(Container, { className: "flex-1 items-center justify-center -mt-10" },
      React.createElement(Card, { className: "flex flex-col items-center justify-center p-8 w-full text-center gap-4" },
        React.createElement('div', { className: "w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mb-2" },
          React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "32", height: "32", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "3", strokeLinecap: "round", strokeLinejoin: "round" },
            React.createElement('polyline', { points: "20 6 9 17 4 12" })
          )
        ),
        React.createElement('h2', { className: "text-2xl font-bold text-gray-800" }, "Record Saved"),
        React.createElement('p', { className: "text-sm text-gray-500" },
          "Screening ID ", React.createElement('span', { className: "font-mono bg-gray-100 px-1 rounded" }, record.screeningId), " has been successfully logged."
        ),
        React.createElement(Button, { className: "mt-6", onClick: onReturn }, "Return to Main Menu")
      )
    )
  );

// ─── GOOGLE SHEETS SAVE ──────────────────────────────────────────

const saveToSheets = async (record) => {
  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...record, timestamp: new Date().toISOString() }),
    });
    return true;
  } catch (e) {
    console.error('Save error:', e);
    return false;
  }
};

// ─── APP SHELL ───────────────────────────────────────────────────

const STEP = { LOGIN:'LOGIN', SESSION:'SESSION', MENU:'MENU', BABY:'BABY', TEST_SELECT:'TEST_SELECT', AABR:'AABR', OAE_TYPE:'OAE_TYPE', OAE_PROTOCOL:'OAE_PROTOCOL', OAE:'OAE', REC:'REC', SYNCING:'SYNCING', SUCCESS:'SUCCESS' };

const App = () => {
  const [step, setStep] = useState(STEP.LOGIN);
  const [record, setRecord] = useState({});
  const merge = d => setRecord(p => ({...p, ...d}));

  const handleSave = async rec => {
    const final = { ...record, recommendation: rec };
    setRecord(final);
    setStep(STEP.SYNCING);
    const ok = await saveToSheets(final);
    setStep(ok ? STEP.SUCCESS : STEP.REC);
    if (!ok) alert('Failed to save. Please check your internet connection and try again.');
  };

  const returnToMenu = () => {
    setRecord({ hwName: record.hwName, hwId: record.hwId, hospitalName: record.hospitalName, sessionDate: record.sessionDate });
    setStep(STEP.MENU);
  };

  const clearBabyData = () => {
    const { hwName, hwId, hospitalName, sessionDate } = record;
    setRecord({ hwName, hwId, hospitalName, sessionDate });
  };

  if (step === STEP.SYNCING) return React.createElement(SyncingScreen);
  if (step === STEP.SUCCESS) return React.createElement(SuccessScreen, { record, onReturn: returnToMenu });

  return React.createElement(React.Fragment, null,
    step === STEP.LOGIN        && React.createElement(LoginScreen, { onSuccess: (name, id) => { merge({hwName:name,hwId:id}); setStep(STEP.SESSION); } }),
    step === STEP.SESSION      && React.createElement(SessionSetupScreen, { initialData: record, onComplete: d => { merge(d); setStep(STEP.MENU); } }),
    step === STEP.MENU         && React.createElement(MainMenuScreen, { record, onNewBaby: () => setStep(STEP.BABY) }),
    step === STEP.BABY         && React.createElement(BabyRegistrationScreen, { initialData: record, onBack: () => setStep(STEP.MENU), onNext: d => { merge(d); setStep(STEP.TEST_SELECT); }, onClear: clearBabyData }),
    step === STEP.TEST_SELECT  && React.createElement(TestSelectionScreen, { onBack: () => setStep(STEP.BABY), onSelect: t => { merge({testType:t}); setStep(t==='AABR'?STEP.AABR:STEP.OAE_TYPE); } }),
    step === STEP.AABR         && React.createElement(AABREntryScreen, { initialData: record, onBack: () => setStep(STEP.TEST_SELECT), onNext: d => { merge(d); setStep(STEP.REC); } }),
    step === STEP.OAE_TYPE     && React.createElement(OAETypeScreen, { onBack: () => setStep(STEP.TEST_SELECT), onNext: d => { merge(d); setStep(STEP.OAE_PROTOCOL); } }),
    step === STEP.OAE_PROTOCOL && React.createElement(OAEProtocolScreen, { oaeType: record.oaeTestType, onBack: () => setStep(STEP.OAE_TYPE), onNext: d => { merge(d); setStep(STEP.OAE); } }),
    step === STEP.OAE          && (record.oaeTestType === 'DPOAE' 
      ? React.createElement(DPOAEEntryScreen, { protocol: record.oaeProtocol, onBack: () => setStep(STEP.OAE_PROTOCOL), onNext: d => { merge(d); setStep(STEP.REC); } })
      : React.createElement(TEOAEEntryScreen, { protocol: record.oaeProtocol, onBack: () => setStep(STEP.OAE_PROTOCOL), onNext: d => { merge(d); setStep(STEP.REC); } })
    ),
    step === STEP.REC          && React.createElement(RecommendationScreen, { onBack: () => setStep(record.testType==='AABR'?STEP.AABR:STEP.OAE), onSave: handleSave })
  );
};

createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
  </body>
</html>
